// Generated by CoffeeScript 1.7.1
(function() {
  var averageComplexity, churn, count, execSync, files, fs, glob, isLiterate, read, report, rules, score, tokens;

  execSync = require("exec-sync");

  tokens = require("coffee-script").tokens;

  rules = require("../lib/rules").rules;

  fs = require("fs");

  glob = require("glob");

  read = function(path) {
    return fs.readFileSync(path, "utf8");
  };

  isLiterate = function(path) {
    return /\.litcoffee|\.coffee\.md/i.test(path);
  };

  churn = function(filePath) {
    var command, output;
    command = "git whatchanged " + filePath + " | grep 'commit' | wc -l";
    output = execSync(command);
    return parseInt(output, 10);
  };

  count = function(filePath) {
    var file;
    file = read(filePath);
    return tokens(file, {
      literate: isLiterate(filePath)
    }).length;
  };

  score = function(filePath) {
    var file;
    file = read(filePath);
    return tokens(file, {
      literate: isLiterate(filePath)
    }).reduce(function(sum, token) {
      var type;
      type = token[0];
      return sum + (rules[type] || 0);
    }, 0);
  };

  averageComplexity = function(filePath) {
    var tokenCount;
    tokenCount = count(filePath);
    if (tokenCount === 0) {
      return 0;
    }
    return score(filePath) / tokenCount;
  };

  files = function(paths) {
    return paths.reduce(function(list, path) {
      var pattern, stats;
      stats = fs.lstatSync(path);
      if (stats.isFile()) {
        list.push(path);
      } else if (stats.isDirectory()) {
        pattern = "" + path + "/**/*\.+(coffee|coffee\.md|litcoffee)";
        list = list.concat(glob.sync(pattern));
      }
      return list;
    }, []);
  };

  report = function(filePaths) {
    return JSON.stringify(files(filePaths).reduce(function(hash, file) {
      hash[file] = {
        averageComplexity: averageComplexity(file),
        churn: churn(file),
        complexity: score(file),
        tokenCount: count(file)
      };
      return hash;
    }, {}));
  };

  exports.clog = {
    churn: churn,
    score: score,
    report: report,
    VERSION: "0.0.10"
  };

}).call(this);
